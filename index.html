<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Sculptor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sora:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-family-body: 'Inter', sans-serif; --font-family-heading: 'Sora', sans-serif; --border-radius-lg: 24px; --border-radius-md: 16px; --border-radius-sm: 12px; --transition-fast: 0.2s; --transition-medium: 0.4s; --ease-out-quart: cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        html[data-theme="light"] { --bg-color: #f4f5f7; --card-color: rgba(255, 255, 255, 0.75); --text-color: #1a1a1a; --text-color-heading: #101010; --subtle-text-color: #5a5a6a; --border-color: rgba(0, 0, 0, 0.08); --shadow-color: rgba(90, 90, 120, 0.1); --accent-color: #6C63FF; --accent-glow: rgba(108, 99, 255, 0.3); --input-bg: #f0f2f5; --slider-track: #e4e4e7; --modal-bg: #ffffff; --success-color: #00A383; --strategy-btn-bg: #e8eaf0; }
        html[data-theme="dark"] { --bg-color: #0d0c12; --card-color: rgba(26, 26, 30, 0.65); --text-color: #e0e0e5; --text-color-heading: #ffffff; --subtle-text-color: #9090a0; --border-color: rgba(255, 255, 255, 0.1); --shadow-color: rgba(0, 0, 0, 0.4); --accent-color: #8179ff; --accent-glow: rgba(129, 121, 255, 0.4); --input-bg: #2a2a30; --slider-track: #333338; --modal-bg: #19191D; --success-color: #00C9B1; --strategy-btn-bg: #3a3a40; }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family-body); background-color: var(--bg-color); color: var(--text-color); display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 2rem; }
        .main-container { width: 100%; max-width: 900px; background: var(--card-color); backdrop-filter: blur(40px); border-radius: var(--border-radius-lg); border: 1px solid var(--border-color); box-shadow: 0 16px 40px -12px var(--shadow-color); padding: 2.5rem 3rem; z-index: 1; }
        header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1.5rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); }
        .header-left { display: flex; align-items: center; gap: 3rem; }
        .app-logo { font-family: var(--font-family-heading); font-size: 1.75rem; color: var(--accent-color); text-decoration: none; }
        nav { display: flex; gap: 1.5rem; }
        nav a { text-decoration: none; color: var(--subtle-text-color); font-weight: 500; transition: color var(--transition-fast) ease; }
        nav a:hover { color: var(--text-color); }
        nav a.active { color: var(--accent-color); font-weight: 600; }
        .btn-primary { background: var(--accent-color); color: white; border: none; padding: 0.8rem 1.6rem; border-radius: var(--border-radius-sm); font-weight: 600; cursor: pointer; transition: all var(--transition-fast) var(--ease-out-quart); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 8px 15px var(--accent-glow); }
        .btn-primary:disabled { background-color: var(--input-bg); color: var(--subtle-text-color); opacity: 0.7; cursor: not-allowed; }
        .premium-feature-btn::after { content: '👑'; margin-left: 0.5em; }
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); display: grid; place-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity var(--transition-medium) ease; }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content { background-color: var(--modal-bg); border-radius: var(--border-radius-md); padding: 2rem; width: 100%; max-width: 500px; border: 1px solid var(--border-color); transform: scale(0.95); transition: transform 0.2s var(--ease-out-quart); }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h2 { font-family: var(--font-family-heading); font-size: 1.5rem; }
        .modal-close-btn { background: none; border: none; color: var(--subtle-text-color); font-size: 1.5rem; cursor: pointer; }
        .modal-form .input-group { margin-bottom: 1rem; }
        .modal-form input, .modal-form select { width: 100%; padding: 0.75rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); color: var(--text-color); font-size: 1rem; }
        .modal-form select { appearance: none; -webkit-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='%239090a0' %3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19.5 8.25l-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1em; }
        .modal-actions { margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem; }
        footer { text-align: center; padding-top: 1.5rem; margin-top: 1.5rem; border-top: 1px solid var(--border-color); color: var(--subtle-text-color); }
        .page-section { display: none; }
        .page-section.active { display: block; animation: fadeIn 0.4s var(--ease-out-quart); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .page-header h1 { font-family: var(--font-family-heading); font-size: 2.5rem; }
        .goals-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2rem; margin-top: 2rem; }
        .goal-card { background-color: var(--card-color); border-radius: var(--border-radius-md); padding: 1.75rem; border: 1px solid var(--border-color); cursor: pointer; }
        .goal-card.completed { opacity: 0.6; border-style: dashed; }
        .goal-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
        .goal-card-header h3 { font-size: 1.25rem; }
        .goal-type-tag { font-weight: 600; background: var(--input-bg); color: var(--subtle-text-color); padding: 4px 8px; border-radius: 8px; font-size: 0.8rem; text-transform: uppercase; }
        .progress-bar-container { width: 100%; height: 10px; background-color: var(--slider-track); border-radius: 5px; overflow: hidden; margin: 1rem 0; }
        .progress-bar { height: 100%; background: var(--accent-color); border-radius: 5px; transition: width 0.4s var(--ease-out-quart); }
        .splitter-container h1 { text-align: center; }
        .strategy-selector { display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: center; }
        .strategy-btn { background-color: var(--strategy-btn-bg); border: 1px solid var(--border-color); padding: 0.6rem 1.1rem; border-radius: var(--border-radius-sm); cursor: pointer; }
        .strategy-btn.active { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
        .split-plan-card { background-color: var(--card-color); border-radius: var(--border-radius-md); margin-top: 2.5rem; padding: 1rem; }
        .split-category-row { padding: 1.5rem; }
        .split-category-row:not(:last-child) { border-bottom: 1px solid var(--border-color); }
        .split-category-row .details h3 { font-size: 1.25rem; }
        .split-category-row .amount-display { text-align: right; }
        .slider { width: 100%; margin-top: 1rem; -webkit-appearance: none; appearance: none; height: 8px; background: var(--slider-track); border-radius: 4px; outline: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; background: #fff; border: 3px solid var(--accent-color); border-radius: 50%; cursor: pointer; }
        .action-plan { margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border-color); }
        .action-plan h2 { text-align: center; margin-bottom: 2rem; }
        .action-item { display: flex; justify-content: space-between; align-items: center; background: var(--card-color); border-radius: var(--border-radius-md); padding: 1rem 1.5rem; margin-bottom: 1rem; }
        #goal-selector-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .goal-template-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem; background-color: var(--input-bg); border-radius: var(--border-radius-sm); padding: 1.25rem; cursor: pointer; }
        .goal-template-btn .icon { font-size: 1.75rem; }
        .goal-template-btn.premium .icon { filter: blur(4px); }
        .transaction-history { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; }
        .transaction-item { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); }
    </style>
</head>
<body>
    <div class="main-container">
        <header>
            <div class="header-left">
                <a href="#splitter" class="app-logo">Financial Sculptor</a>
                <nav>
                    <a href="#splitter" class="nav-link active">Splitter</a>
                    <a href="#goals" class="nav-link">Goals</a>
                    <a href="#studio" class="nav-link premium-feature-btn" style="pointer-events: none; opacity: 0.6;">Studio</a>
                </nav>
            </div>
        </header>
        <main>
            <section id="splitter" class="page-section active">
                 <div class="splitter-container">
                    <h1 class="page-header">You have <span id="amount-title"></span>. Let's make a plan.</h1>
                    <div class="input-group" style="max-width: 300px; margin: 0 auto 2rem;"><input type="number" id="profit-amount" value="10000" min="0"></div>
                    <div class="input-group"><div id="splitter-strategy-selector" class="strategy-selector"></div></div>
                    <div id="splitter-allocation-container"></div>
                    <div id="action-plan-container"></div>
                </div>
            </section>
            <section id="goals" class="page-section">
                <div class="page-header"><h1>Your Goals</h1><div><button class="btn-primary premium-feature-btn" id="export-btn" disabled>Export</button><button class="btn-primary" id="add-goal-btn" title="Add New Goal">+</button></div></div>
                <div class="goals-grid" id="goals-grid-container"></div>
            </section>
            <section id="studio" class="page-section"><div style="text-align: center; padding: 4rem 0;"><h1 style="font-size: 3rem;">👑</h1><h1 class="page-header">The Advanced Strategy Studio</h1><p style="max-width: 450px; margin: 0 auto 2rem;">Unlock the Studio for multi-category splits and unparalleled control over your financial plan.</p><button class="btn-primary" id="studio-upgrade-btn">Upgrade to Unlock The Studio</button></div></section>
        </main>
        <footer>&copy; 2025 Crude Capital. <button class="reset-btn" id="reset-data-btn">Reset Saved Goals</button></footer>
    </div>
    <div class="modal-overlay" id="add-goal-chooser-modal"><div class="modal-content" style="max-width: 540px;"><div class="modal-header"><h2>Choose a Goal Type</h2><button class="modal-close-btn">&times;</button></div><div id="goal-selector-grid"></div></div></div>
    <div class="modal-overlay" id="goal-form-modal"><div class="modal-content"><div class="modal-header"><h2 id="goal-form-title"></h2><button class="modal-close-btn">&times;</button></div><form id="add-goal-form" class="modal-form"><input type="hidden" id="goal-template-id"><input type="hidden" id="goal-type-hidden"><div class="input-group"><label for="goal-name">Goal Name</label><input type="text" id="goal-name" required></div><div class="input-group" id="custom-goal-type-group"><label for="custom-goal-type">Goal Type</label><select id="custom-goal-type" required><option value="" disabled selected>-- Select a type --</option><option value="now">Cash</option><option value="soon">Savings</option><option value="later">Investments</option></select></div><div class="input-group"><label for="target-amount">Target Amount</label><input type="number" id="target-amount" required min="1"></div><div class="input-group"><label for="current-amount">Current Amount</label><input type="number" id="current-amount" required value="0"></div><div class="modal-actions"><button type="button" class="btn-primary" style="background-color: var(--input-bg); color: var(--text-color);" id="goal-form-cancel-btn">Cancel</button><button type="submit" class="btn-primary">Save Goal</button></div></form></div></div>
    <div class="modal-overlay" id="goal-details-modal"><div class="modal-content"><div class="modal-header"><h2 id="goal-details-title"></h2><button class="modal-close-btn">&times;</button></div><div id="goal-details-body"></div></div></div>
    <div class="modal-overlay" id="upgrade-modal"><div class="modal-content" style="text-align: center;"><div class="modal-header" style="justify-content:center; border-bottom: none;"><h2 id="upgrade-title"></h2></div><p id="upgrade-message" style="margin: 1rem 0 2rem;"></p><div class="modal-actions" style="justify-content: center;"><button class="btn-primary" id="upgrade-now-btn">Upgrade to Premium</button></div></div></div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const App = {
        state: {
            currentPage: 'splitter', currency: 'USD', goals: [],
            splitter: { total: 10000, activeStrategy: 'balanced', customSplit: { now: 30, soon: 40, later: 30 } }
        },
        config: {
            GOALS_STORAGE_KEY: 'fsculpt.goals', MAX_FREE_GOALS: 3,
            GoalTemplates: {
                free: [
                    { id: 'emergency_fund', name: 'Emergency Fund', icon: '🛡️', type: 'now', target: 5000 },
                    { id: 'house_down_payment', name: 'House Down Payment', icon: '🏠', type: 'soon', target: 50000 },
                    { id: 'investment_portfolio', name: 'Investment Portfolio', icon: '📈', type: 'later', target: 25000 }
                ],
                premium: [ { icon: '🎓' }, { icon: '🚀' }, { icon: '✈️' }, { icon: '❤️‍🩹' }, { icon: '🌳' } ]
            },
            SplitterStrategies: {
                safety: { name: "Safety First", split: { now: 60, soon: 30, later: 10 } },
                balanced: { name: "Balanced Plan", split: { now: 30, soon: 40, later: 30 } },
                growth: { name: "Growth Focus", split: { now: 10, soon: 20, later: 70 } },
                custom: { name: "Custom" }
            },
            SplitterCategories: {
                now: { title: 'Cash', description: 'For your emergency fund & safety.', color: '#8179ff' },
                soon: { title: 'Savings', description: 'For goals in the next 1-5 years.', color: '#00C9B1' },
                later: { title: 'Investments', description: 'For long-term wealth & retirement.', color: '#FF6B6B' }
            }
        },
        init() {
            this.cacheDom();
            this.state.goals = this.loadGoals();
            this.setCurrency(localStorage.getItem('fsculpt.currency') || 'USD', true);
            this.renderAll();
            this.bindEvents();
            this.navigateTo(window.location.hash.substring(1));
        },
        cacheDom() {
            this.DOM = {
                navLinks: document.querySelectorAll('nav .nav-link'),
                pages: document.querySelectorAll('.page-section'),
                amountTitle: document.getElementById('amount-title'),
                goalsGrid: document.getElementById('goals-grid-container'),
                addGoalBtn: document.getElementById('add-goal-btn'),
                goalChooserModal: document.getElementById('add-goal-chooser-modal'),
                goalFormModal: document.getElementById('goal-form-modal'),
                goalDetailsModal: document.getElementById('goal-details-modal'),
                upgradeModal: document.getElementById('upgrade-modal'),
                resetDataBtn: document.getElementById('reset-data-btn'),
                exportBtn: document.getElementById('export-btn'),
                profitInput: document.getElementById('profit-amount'),
                splitterStrategySelector: document.getElementById('splitter-strategy-selector'),
                splitterAllocationContainer: document.getElementById('splitter-allocation-container'),
                actionPlanContainer: document.getElementById('action-plan-container'),
                goalForm: document.getElementById('add-goal-form'),
            };
        },
        renderAll() {
            this.renderGoals();
            this.applySplitterStrategy(this.state.splitter.activeStrategy);
        },
        bindEvents() {
            this.DOM.navLinks.forEach(link => link.addEventListener('click', e => {
                if(link.classList.contains('premium-feature-btn')) {
                    e.preventDefault();
                    this.showUpgradeModal('The Advanced Strategy Studio', 'The Studio is a premium feature for multi-category splits and unparalleled control. Upgrade to unlock.');
                } else { this.navigateTo(e.target.hash.substring(1)); }
            }));
            document.querySelector('.app-logo').addEventListener('click', e => this.navigateTo('splitter'));
            this.DOM.addGoalBtn.addEventListener('click', () => this.openGoalChooser());
            this.DOM.exportBtn.addEventListener('click', () => this.showUpgradeModal('Export Your Goals', 'Export your goals and transaction history as a CSV file with a Premium account.'));
            this.DOM.goalForm.addEventListener('submit', e => this.handleGoalFormSubmit(e));
            this.DOM.resetDataBtn.addEventListener('click', () => this.resetData());
            [this.DOM.goalChooserModal, this.DOM.goalFormModal, this.DOM.goalDetailsModal, this.DOM.upgradeModal].forEach(m => {
                m.addEventListener('click', e => {
                    if (e.target === m || e.target.closest('.modal-close-btn, #goal-form-cancel-btn')) m.classList.remove('active');
                    if (e.target.closest('#upgrade-now-btn')) { alert("Redirecting to checkout..."); m.classList.remove('active'); }
                });
            });
            this.DOM.profitInput.addEventListener('input', e => {
                this.state.splitter.total = parseFloat(e.target.value) || 0;
                this.DOM.amountTitle.textContent = this.formatCurrency(this.state.splitter.total);
                this.renderSplitter();
            });
            this.DOM.splitterStrategySelector.addEventListener('click', e => {
                const button = e.target.closest('.strategy-btn:not(:disabled)');
                if (button) this.applySplitterStrategy(button.dataset.strategy);
            });
            this.DOM.actionPlanContainer.addEventListener('click', e => {
                const button = e.target.closest('.btn-apply');
                if (button) {
                    const { goalId, amount } = button.dataset;
                    this.applyFundsToGoal(goalId, parseFloat(amount));
                }
            });
            this.DOM.goalChooserModal.addEventListener('click', e => {
                const button = e.target.closest('.goal-template-btn');
                if (!button || button.disabled) return;
                this.DOM.goalChooserModal.classList.remove('active');
                if (button.dataset.id === 'custom') {
                    this.openGoalForm();
                } else if (button.dataset.id === 'premium') {
                    this.showUpgradeModal('Unlock Premium Goals', 'Unlock the full collection of goal types with Premium.');
                } else {
                    const template = this.config.GoalTemplates.free.find(t => t.id === button.dataset.id);
                    this.openGoalForm(template);
                }
            });
            this.DOM.goalsGrid.addEventListener('click', e => {
                const card = e.target.closest('.goal-card');
                if (card) this.openGoalDetails(card.dataset.goalId);
            });
        },
        navigateTo(pageId) {
            pageId = ['splitter', 'goals', 'studio'].includes(pageId) ? pageId : 'splitter';
            this.state.currentPage = pageId;
            this.DOM.pages.forEach(p => p.classList.toggle('active', p.id === pageId));
            this.DOM.navLinks.forEach(l => l.classList.toggle('active', l.hash === `#${pageId}`));
        },
        setCurrency(currencyCode, isInitial = false) {
            this.state.currency = currencyCode;
            if (!isInitial) localStorage.setItem('fsculpt.currency', currencyCode);
            this.DOM.amountTitle.textContent = this.formatCurrency(this.state.splitter.total);
            this.renderAll();
        },
        formatCurrency(amount) {
            try {
                return new Intl.NumberFormat(undefined, { style: 'currency', currency: this.state.currency }).format(amount || 0).replace(/[A-Z]{3}/, '').trim();
            } catch (e) {
                return `$${(amount || 0).toFixed(2)}`;
            }
        },
        loadGoals() { return JSON.parse(localStorage.getItem(this.config.GOALS_STORAGE_KEY)) || []; },
        saveGoals() { localStorage.setItem(this.config.GOALS_STORAGE_KEY, JSON.stringify(this.state.goals)); },
        renderGoals() {
            this.DOM.goalsGrid.innerHTML = this.state.goals.map((goal) => {
                const progress = goal.target > 0 ? (goal.current / goal.target) * 100 : 0;
                const isCompleted = progress >= 100;
                return `<div class="goal-card ${isCompleted ? 'completed' : ''}" data-goal-id="${goal.id}">
                    <div class="goal-card-header"><h3>${goal.name}</h3><span class="goal-type-tag">${goal.type}</span></div>
                    <div>${this.formatCurrency(goal.current)} of ${this.formatCurrency(goal.target)}</div>
                    <div class="progress-bar-container"><div class="progress-bar" style="width: ${progress > 100 ? 100 : progress}%;"></div></div>
                    ${isCompleted ? '<div style="text-align: right; font-weight: bold; color: var(--success-color);">✓ Completed</div>' : ''}
                    </div>`;
            }).join('') || `<p style="grid-column: 1 / -1; text-align: center; color: var(--subtle-text-color);">Click the '+' to create your first goal.</p>`;
        },
        showUpgradeModal(title, message) {
            const modal = this.DOM.upgradeModal;
            modal.querySelector('#upgrade-title').textContent = title;
            modal.querySelector('#upgrade-message').textContent = message;
            modal.classList.add('active');
        },
        openGoalChooser() {
            if (this.state.goals.length >= this.config.MAX_FREE_GOALS) {
                this.showUpgradeModal('Goal Limit Reached', `You've reached the ${this.config.MAX_FREE_GOALS}-goal limit. Upgrade to create unlimited goals.`);
                return;
            }
            const grid = this.DOM.goalChooserModal.querySelector('#goal-selector-grid');
            const existingGoalIds = this.state.goals.map(g => g.templateId);
            const freeGoalsHtml = this.config.GoalTemplates.free.map(g => `<button class="goal-template-btn" data-id="${g.id}" ${existingGoalIds.includes(g.id) ? 'disabled' : ''}><span class="icon">${g.icon}</span><span>${g.name}</span></button>`).join('');
            grid.innerHTML = `<div style="grid-column: 1 / -1;">Free Goals</div>${freeGoalsHtml}<button class="goal-template-btn" data-id="custom"><span class="icon">✨</span><span>Custom Goal</span></button><div style="grid-column: 1 / -1; margin-top: 1rem;">Premium Collection</div><button class="goal-template-btn premium full-width-btn" data-id="premium"><div style="display: flex; gap: 1rem; filter: blur(4px);">${this.config.GoalTemplates.premium.map(p => `<span class="icon">${p.icon}</span>`).join('')}</div><span style="margin-top: 1rem;">👑 Upgrade to Unlock</span></button>`;
            this.DOM.goalChooserModal.classList.add('active');
        },
        openGoalForm(template = null) {
            const modal = this.DOM.goalFormModal;
            const form = this.DOM.goalForm;
            form.reset();
            modal.querySelector('#goal-form-title').textContent = template ? `Create ${template.name}` : 'Create Custom Goal';
            form.elements['goal-name'].value = template ? template.name : '';
            form.elements['target-amount'].value = template ? template.target : '';
            form.elements['goal-template-id'].value = template ? template.id : 'custom';
            form.elements['goal-type-hidden'].value = template ? template.type : '';
            form.elements['custom-goal-type-group'].style.display = template ? 'none' : 'block';
            modal.classList.add('active');
        },
        handleGoalFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const templateId = form.elements['goal-template-id'].value;
            const isCustom = templateId === 'custom';
            const goalType = isCustom ? form.elements['custom-goal-type'].value : form.elements['goal-type-hidden'].value;

            if (isCustom && !goalType) {
                alert('Please select a goal type for your custom goal.');
                return;
            }

            const newGoal = {
                id: Date.now(), templateId: templateId,
                name: form.elements['goal-name'].value, type: goalType,
                current: parseFloat(form.elements['current-amount'].value) || 0,
                target: parseFloat(form.elements['target-amount'].value), transactions: []
            };
            if(newGoal.current > 0) newGoal.transactions.push({ amount: newGoal.current, date: new Date().toISOString(), source: 'Initial Amount'});
            this.state.goals.push(newGoal);
            this.saveGoals(); this.renderGoals(); this.renderSplitter();
            this.DOM.goalFormModal.classList.remove('active');
        },
        openGoalDetails(goalId) {
            const goal = this.state.goals.find(g => g.id == goalId);
            if (!goal) return;
            const modal = this.DOM.goalDetailsModal;
            modal.querySelector('#goal-details-title').textContent = goal.name;
            const body = modal.querySelector('#goal-details-body');
            const history = goal.transactions && goal.transactions.length > 0
                ? [...goal.transactions].reverse().map(t => `<li class="transaction-item"><span>${new Date(t.date).toLocaleDateString()} - ${t.source}</span><span>+${this.formatCurrency(t.amount)}</span></li>`).join('')
                : '<li>No contributions yet.</li>';
            body.innerHTML = `<p><strong>Progress:</strong> ${this.formatCurrency(goal.current)} / ${this.formatCurrency(goal.target)}</p><h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">History</h4><ul class="transaction-history">${history}</ul>`;
            modal.classList.add('active');
        },
        resetData() { if (confirm("This will reset all goals. Are you sure?")) { localStorage.clear(); location.reload(); } },
        applySplitterStrategy(key) {
            this.state.splitter.activeStrategy = key;
            const selector = this.DOM.splitterStrategySelector;
            const strategies = Object.keys(this.config.SplitterStrategies);
            selector.innerHTML = strategies.map(k => `<button class="strategy-btn ${k === key ? 'active' : ''}" data-strategy="${k}">${this.config.SplitterStrategies[k].name}</button>`).join('')
             + `<button class="strategy-btn premium-feature-btn" id="advanced-strategies-btn" disabled>Advanced</button>`;
            
            const advancedBtn = selector.querySelector('#advanced-strategies-btn');
            if(advancedBtn) advancedBtn.addEventListener('click', () => this.showUpgradeModal('Unlock Advanced Strategies', 'The Studio is a premium feature with advanced strategies and multi-category splits.'));

            if (key !== 'custom') this.state.splitter.customSplit = { ...this.config.SplitterStrategies[key].split };
            this.renderSplitter();
        },
        renderSplitter() {
            const isCustom = this.state.splitter.activeStrategy === 'custom';
            const split = isCustom ? this.state.splitter.customSplit : this.config.SplitterStrategies[this.state.splitter.activeStrategy].split;
            let categoriesHTML = '';
            for (const key in this.config.SplitterCategories) {
                const category = this.config.SplitterCategories[key];
                const value = this.state.splitter.total * ((split[key] || 0) / 100);
                categoriesHTML += `<div class="split-category-row"><div class="details"><h3>${category.title}</h3><p>${category.description}</p>${isCustom ? `<input type="range" class="slider" data-key="${key}" value="${split[key] || 0}" min="0" max="100" step="1">` : ''}</div><div class="amount-display"><div class="percent" style="color:${category.color}">${Math.round(split[key] || 0)}%</div><div>${this.formatCurrency(value)}</div></div></div>`;
            }
            this.DOM.splitterAllocationContainer.innerHTML = `<div class="split-plan-card">${categoriesHTML}</div>`;
            if (isCustom) this.DOM.splitterAllocationContainer.querySelectorAll('.slider').forEach(slider => slider.addEventListener('input', e => this.handleSplitterSliderInput(e)));
            this.renderActionPlan();
        },
        handleSplitterSliderInput(e) {
            const updatedKey = e.target.dataset.key;
            let newValue = parseFloat(e.target.value);
            const oldValue = this.state.splitter.customSplit[updatedKey];
            const diff = newValue - oldValue;
            
            let otherTotal = 100 - oldValue;
            if(otherTotal <= 0) {
                let otherKeys = Object.keys(this.state.splitter.customSplit).filter(k => k !== updatedKey);
                otherKeys.forEach(k => { this.state.splitter.customSplit[k] = (100 - newValue) / otherKeys.length; });
            } else {
                for (const key in this.state.splitter.customSplit) {
                    if (key !== updatedKey) {
                        const proportion = this.state.splitter.customSplit[key] / otherTotal;
                        this.state.splitter.customSplit[key] -= diff * proportion;
                    }
                }
            }
            this.state.splitter.customSplit[updatedKey] = newValue;

            let total = 0;
            for(const key in this.state.splitter.customSplit) { if(this.state.splitter.customSplit[key] < 0) this.state.splitter.customSplit[key] = 0; total += this.state.splitter.customSplit[key]; }
            if (total > 0) { const factor = 100 / total; for(const key in this.state.splitter.customSplit) { this.state.splitter.customSplit[key] *= factor; } }
            
            this.renderSplitter();
        },
        renderActionPlan() {
            const split = this.state.splitter.activeStrategy === 'custom' ? this.state.splitter.customSplit : this.config.SplitterStrategies[this.state.splitter.activeStrategy].split;
            const funds = { now: this.state.splitter.total * (split.now/100), soon: this.state.splitter.total * (split.soon/100), later: this.state.splitter.total * (split.later/100) };
            const relevantGoals = this.state.goals.filter(g => funds[g.type] > 0 && g.current < g.target);
            let planHTML = '';
            if (relevantGoals.length > 0) {
                planHTML += '<h2>Your Action Plan</h2>';
                relevantGoals.forEach(goal => { planHTML += `<div class="action-item"><span>Apply to ${goal.name}</span><button class="btn-primary btn-apply" data-goal-id="${goal.id}" data-amount="${funds[goal.type]}">+ ${this.formatCurrency(funds[goal.type])}</button></div>`; });
            } else if (this.state.splitter.total > 0) {
                planHTML += `<div style="text-align:center; margin-top: 3rem;"><p>Create a goal to assign these funds.</p><button class="btn-primary" onclick="App.openGoalChooser()">+ Create a Goal</button></div>`;
            }
            this.DOM.actionPlanContainer.innerHTML = `<div class="action-plan">${planHTML}</div>`;
        },
        applyFundsToGoal(goalId, amount) {
            const goalIndex = this.state.goals.findIndex(g => g.id == goalId);
            if (goalIndex === -1) return;
            this.state.goals[goalIndex].current += amount;
            if (!this.state.goals[goalIndex].transactions) this.state.goals[goalIndex].transactions = [];
            this.state.goals[goalIndex].transactions.push({ amount, date: new Date().toISOString(), source: 'Splitter' });
            this.saveGoals(); this.renderGoals();
            this.DOM.actionPlanContainer.querySelector(`[data-goal-id="${goalId}"]`).closest('.action-item').innerHTML = `<span style="color: var(--success-color);">✓ Applied to ${this.state.goals[goalIndex].name}!</span>`;
        }
    };

    App.init();
});
</script>
</body>
</html>
